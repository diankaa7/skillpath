// AI Service для работы с различными AI API
// Поддерживает несколько провайдеров для гибкости

class AIService {
  constructor() {
    this.apiKey = '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'; // Можно добавить через настройки
    this.provider = 'openai'; // openai, anthropic, huggingface, local
    this.baseURL = 'https://api.openai.com/v1';
    this.model = 'gpt-4o-mini'; // Более новая и быстрая модель, лучше понимает контекст
  }

  // Универсальный метод для вызова AI
  async callAI(messages, options = {}) {
    try {
      // Если нет API ключа или ключ невалидный, используем локальную логику
      if (!this.apiKey || this.apiKey === 'null' || this.apiKey === 'undefined' || !this.apiKey.startsWith('sk-')) {
        console.log('Using fallback: No valid API key');
        return this.fallbackResponse(messages);
      }
      
      console.log('Calling OpenAI API with model:', this.model);

      const response = await fetch(`${this.baseURL}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model: this.model,
          messages: messages,
          temperature: options.temperature || 0.7,
          max_tokens: options.max_tokens || 500
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        console.error('API Error:', response.status, errorData);
        console.error('Error details:', JSON.stringify(errorData, null, 2));
        
        // Если ошибка авторизации или невалидный ключ
        if (response.status === 401 || response.status === 403) {
          console.log('Invalid API key, using fallback');
          return this.fallbackResponse(messages);
        }
        
        // Для других ошибок тоже используем fallback
        console.log('API request failed, using fallback');
        return this.fallbackResponse(messages);
      }

      const data = await response.json();
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('Invalid API response format');
      }
      
      const aiResponse = data.choices[0].message.content;
      console.log('AI Response received:', aiResponse.substring(0, 100) + '...');
      
      // Проверяем, что ответ не пустой и не слишком короткий
      if (!aiResponse || aiResponse.trim().length < 10) {
        console.warn('AI response too short, using fallback');
        return this.fallbackResponse(messages);
      }
      
      return aiResponse;
    } catch (error) {
      console.error('AI API Error:', error);
      // Fallback на локальную логику
      return this.fallbackResponse(messages);
    }
  }

  // Fallback - умная локальная логика когда API недоступен
  fallbackResponse(messages) {
    const lastMessage = messages[messages.length - 1]?.content || '';
    const lowerMessage = lastMessage.toLowerCase();
    
    console.log('Fallback triggered for message:', lowerMessage.substring(0, 50));
    
    // Определяем тип запроса по контексту с более детальным анализом
    
    // Профессии
    if (lowerMessage.includes('профессия') || lowerMessage.includes('рекомендация') || 
        lowerMessage.includes('кем стать') || lowerMessage.includes('какую профессию') ||
        lowerMessage.includes('какая профессия') || lowerMessage.includes('профессии подходят')) {
      return this.getLocalProfessionRecommendation(messages);
    }
    
    // Конкретные навыки
    if (lowerMessage.includes('аналитическ') || lowerMessage.includes('анализ')) {
      return "Для развития аналитического мышления рекомендую: 1) Решать логические задачи и головоломки ежедневно, 2) Изучать математику и статистику, 3) Анализировать данные из реальных проектов, 4) Читать научную литературу и исследования, 5) Практиковаться на платформах типа Kaggle или LeetCode.";
    }
    
    if (lowerMessage.includes('коммуникативн') || lowerMessage.includes('общени')) {
      return "Для улучшения коммуникативных навыков: 1) Участвуйте в дебатах и дискуссиях, 2) Практикуйте публичные выступления, 3) Развивайте активное слушание, 4) Изучайте психологию общения, 5) Работайте в командах над проектами, 6) Читайте книги по риторике и переговорам.";
    }
    
    if (lowerMessage.includes('творческ') || lowerMessage.includes('креативн')) {
      return "Для развития творческого мышления: 1) Экспериментируйте с разными техниками и стилями, 2) Изучайте искусство и дизайн, 3) Ведите творческий дневник или скетчбук, 4) Практикуйте мозговой штурм, 5) Изучайте работы мастеров в вашей области, 6) Пробуйте новые инструменты и материалы.";
    }
    
    if (lowerMessage.includes('техническ') || lowerMessage.includes('программирован')) {
      return "Для развития технических навыков: 1) Изучайте программирование через практику (freeCodeCamp, The Odin Project), 2) Работайте над реальными проектами, 3) Изучайте документацию и исходный код, 4) Участвуйте в open-source проектах, 5) Решайте задачи на LeetCode, HackerRank, 6) Создавайте портфолио с проектами.";
    }
    
    if (lowerMessage.includes('лидерск') || lowerMessage.includes('управлен')) {
      return "Для развития лидерских качеств: 1) Возьмите на себя ответственность за проекты, 2) Изучайте теории лидерства, 3) Практикуйте делегирование задач, 4) Развивайте эмоциональный интеллект, 5) Учитесь принимать решения, 6) Найдите ментора-лидера.";
    }
    
    // Навыки в общем
    if (lowerMessage.includes('навык') || lowerMessage.includes('развитие') || 
        lowerMessage.includes('развить') || lowerMessage.includes('улучшить') ||
        lowerMessage.includes('какие навыки') || lowerMessage.includes('нужны')) {
      return this.getLocalSkillAdvice(messages);
    }
    
    // Конкретные профессии
    if (lowerMessage.includes('программист') || lowerMessage.includes('разработчик')) {
      return "Для работы программистом нужны: 1) Знание языков программирования (Python, JavaScript, Java и др.), 2) Понимание алгоритмов и структур данных, 3) Опыт работы с Git, 4) Знание фреймворков и библиотек, 5) Умение решать задачи и отлаживать код. Начните с бесплатных курсов на freeCodeCamp, The Odin Project или Stepik.";
    }
    
    if (lowerMessage.includes('дизайнер') || lowerMessage.includes('дизайн')) {
      return "Для работы дизайнером нужно: 1) Развить чувство композиции и цвета, 2) Освоить инструменты (Figma, Adobe Photoshop, Illustrator), 3) Изучить принципы UX/UI дизайна, 4) Создать портфолио с проектами, 5) Изучать работы других дизайнеров. Начните с курсов на Coursera (Google UX Design) или Skillbox.";
    }
    
    if (lowerMessage.includes('психолог')) {
      return "Для работы психологом нужно: 1) Получить высшее образование по психологии, 2) Развить навыки эмпатии и активного слушания, 3) Изучить различные направления психологии, 4) Пройти практику и супервизию, 5) Получить лицензию. Можно начать с курсов на Coursera (Yale - The Science of Well-Being) или Открытом образовании.";
    }
    
    if (lowerMessage.includes('маркетолог') || lowerMessage.includes('маркетинг')) {
      return "Для работы маркетологом нужно: 1) Изучить основы маркетинга и рекламы, 2) Освоить digital-инструменты (Google Analytics, SMM), 3) Развить аналитические навыки, 4) Изучить поведение потребителей, 5) Практиковаться на реальных проектах. Начните с курсов HubSpot Academy или Google Digital Garage.";
    }
    
    // Обучение и курсы
    if (lowerMessage.includes('курс') || lowerMessage.includes('обучение') || 
        lowerMessage.includes('изучить') || lowerMessage.includes('научиться') ||
        lowerMessage.includes('где учиться') || lowerMessage.includes('где изучить')) {
      if (lowerMessage.includes('бесплатн')) {
        return "Бесплатные платформы для обучения: 1) Coursera (можно слушать бесплатно), 2) edX (курсы от ведущих университетов), 3) Stepik (русскоязычные курсы), 4) freeCodeCamp (программирование), 5) Khan Academy, 6) Открытое образование (российские вузы). Большинство платформ предлагают бесплатный доступ к материалам без сертификата.";
      }
      return "Для обучения рекомендую: 1) Начать с бесплатных курсов на Coursera, edX, Stepik, 2) Практиковаться на реальных проектах, 3) Изучать документацию и примеры, 4) Найти ментора или сообщество единомышленников, 5) Создавать портфолио с проектами.";
    }
    
    // Университеты
    if (lowerMessage.includes('университет') || lowerMessage.includes('вуз') || 
        lowerMessage.includes('колледж') || lowerMessage.includes('где учиться')) {
      if (lowerMessage.includes('москв')) {
        return "В Москве лучшие университеты: МГУ, МФТИ, ВШЭ, МГИМО, МГТУ им. Баумана, РАНХиГС. Для IT: МФТИ, ВШЭ, МГТУ им. Баумана. Для гуманитарных: МГУ, ВШЭ, МГИМО. Выберите город в результатах теста, чтобы увидеть полный список.";
      }
      if (lowerMessage.includes('санкт-петербург') || lowerMessage.includes('спб')) {
        return "В Санкт-Петербурге лучшие университеты: СПбГУ, Университет ИТМО, СПбПУ, СПбГЭУ. Для IT: ИТМО, СПбПУ. Для гуманитарных: СПбГУ. Выберите город в результатах теста, чтобы увидеть полный список.";
      }
      return "Для выбора учебного заведения рекомендую: 1) Определить интересующую профессию, 2) Выбрать город для обучения, 3) Изучить программы и рейтинги вузов/колледжей, 4) Обратить внимание на проходные баллы и требования. Выберите город в результатах теста выше, чтобы увидеть список учебных заведений.";
    }
    
    // Карьера
    if (lowerMessage.includes('карьер') || lowerMessage.includes('работа') || 
        lowerMessage.includes('трудоустройство') || lowerMessage.includes('начать карьеру')) {
      if (lowerMessage.includes('начать') || lowerMessage.includes('с чего')) {
        return "Чтобы начать карьеру: 1) Определите интересующую сферу, 2) Изучите необходимые навыки, 3) Пройдите курсы или обучение, 4) Создайте портфолио или резюме, 5) Ищите стажировки или junior позиции, 6) Развивайте профессиональную сеть, 7) Не бойтесь начинать с малого.";
      }
      return "Для успешной карьеры важно: 1) Развивать профессиональные навыки, 2) Строить портфолио и резюме, 3) Участвовать в профессиональных сообществах, 4) Непрерывно учиться и адаптироваться к изменениям, 5) Ставить конкретные цели, 6) Искать ментора.";
    }
    
    // Резюме и собеседование
    if (lowerMessage.includes('резюме') || lowerMessage.includes('cv')) {
      return "Для составления резюме: 1) Укажите релевантный опыт и навыки, 2) Добавьте конкретные достижения с цифрами, 3) Адаптируйте резюме под каждую вакансию, 4) Используйте ключевые слова из описания вакансии, 5) Сделайте резюме читаемым и структурированным, 6) Добавьте ссылку на портфолио или GitHub.";
    }
    
    if (lowerMessage.includes('собеседован')) {
      return "Для подготовки к собеседованию: 1) Изучите компанию и её продукты, 2) Подготовьте ответы на типовые вопросы, 3) Подготовьте вопросы для интервьюера, 4) Практикуйте рассказ о себе, 5) Подготовьте примеры ваших достижений, 6) Будьте готовы к техническим вопросам по специальности.";
    }
    
    // Общие советы
    if (lowerMessage.includes('совет') || lowerMessage.includes('помощь') || 
        lowerMessage.includes('помоги') || lowerMessage.includes('что делать') ||
        lowerMessage.includes('как быть')) {
      return this.getLocalGeneralAdvice(messages);
    }
    
    // Если ничего не подошло, даем более полезный ответ
    return this.generateContextualResponse(lowerMessage);
  }
  
  // Генерация контекстного ответа на основе ключевых слов
  generateContextualResponse(message) {
    // Ищем ключевые слова и даем конкретный ответ
    const keywords = {
      'it': "Для работы в IT нужно: знание программирования, понимание алгоритмов, опыт с проектами. Начните с freeCodeCamp или The Odin Project.",
      'данн': "Для работы с данными изучайте Python, SQL, статистику. Курсы на Kaggle Learn, DataCamp, Stepik.",
      'удаленн': "Для удаленной работы важны: самодисциплина, коммуникация онлайн, тайм-менеджмент. Многие IT и дизайн профессии позволяют работать удаленно.",
      'перв': "Для первой работы: ищите стажировки, создайте портфолио, участвуйте в проектах, не бойтесь junior позиций.",
      'опыт': "Без опыта: создавайте проекты для портфолио, участвуйте в open-source, делайте стажировки, учитесь на практике.",
      'зарплат': "Зарплата зависит от опыта, навыков, города, компании. Развивайте навыки, создавайте ценность, изучайте рынок.",
      'выбор': "Для выбора профессии: пройдите наш тест, изучите профессии, поговорите с профессионалами, попробуйте на практике.",
      'не знаю': "Если не знаете, кем стать: 1) Пройдите наш тест на профориентацию, 2) Изучите разные профессии, 3) Попробуйте стажировки, 4) Поговорите с людьми из разных сфер, 5) Не бойтесь пробовать новое."
    };
    
    for (const [keyword, response] of Object.entries(keywords)) {
      if (message.includes(keyword)) {
        return response;
      }
    }
    
    // Если все еще не нашли, даем общий но полезный ответ
    return "Я могу помочь вам с вопросами о выборе профессии, развитии навыков, выборе учебного заведения и карьерном планировании. Задайте конкретный вопрос, например: 'Как развить аналитическое мышление?' или 'Какие навыки нужны программисту?', и я дам детальный ответ!";
  }

  // Локальная логика для рекомендаций профессий
  getLocalProfessionRecommendation(messages) {
    // Извлекаем данные из сообщений
    const systemMessage = messages.find(m => m.role === 'system')?.content || '';
    const userMessage = messages.find(m => m.role === 'user')?.content || '';
    
    // Парсим данные если они есть в JSON формате
    let skillScores = {};
    let userAnswers = [];
    
    try {
      const skillMatch = userMessage.match(/Навыки[:\s]*({[^}]+})/);
      const answerMatch = userMessage.match(/Ответы[:\s]*(\[[^\]]+\])/);
      
      if (skillMatch) skillScores = JSON.parse(skillMatch[1]);
      if (answerMatch) userAnswers = JSON.parse(answerMatch[1]);
    } catch (e) {
      // Если не JSON, используем текстовый анализ
    }

    // Улучшенная логика определения профессии
    const sortedSkills = Object.entries(skillScores).sort((a, b) => b[1] - a[1]);
    const topSkills = sortedSkills.slice(0, 3).map(s => s[0]);

    let recommendation = "Инженер-программист";
    let reasoning = "";

    if (topSkills.includes("Коммуникативные навыки") && topSkills.includes("Работа в команде")) {
      if (userAnswers.includes(0) || userAnswers.includes(4)) {
        recommendation = "Психолог";
        reasoning = "Ваши сильные коммуникативные навыки и желание помогать людям делают вас отличным кандидатом для работы в психологии.";
      } else {
        recommendation = "Учитель";
        reasoning = "Ваша способность работать с людьми и передавать знания идеально подходит для педагогической деятельности.";
      }
    } else if (topSkills.includes("Аналитическое мышление") && topSkills.includes("Технические навыки")) {
      if (userAnswers.includes(1)) {
        recommendation = "Data Scientist";
        reasoning = "Ваш аналитический склад ума и технические навыки идеальны для работы с большими данными.";
      } else {
        recommendation = "Инженер-программист";
        reasoning = "Сочетание аналитического мышления и технических навыков делает вас отличным программистом.";
      }
    } else if (topSkills.includes("Творческий подход")) {
      recommendation = "Веб-дизайнер";
      reasoning = "Ваш творческий потенциал и визуальное мышление отлично подходят для дизайна.";
    } else if (topSkills.includes("Организационные способности")) {
      recommendation = "Менеджер по продажам";
      reasoning = "Ваши организационные навыки и способность управлять проектами идеальны для менеджмента.";
    }

    return `${recommendation}. ${reasoning}`;
  }

  // Локальная логика для советов по навыкам
  getLocalSkillAdvice(messages) {
    const userMessage = messages[messages.length - 1]?.content || '';
    const lowerMessage = userMessage.toLowerCase();
    
    // Расширенный список навыков с ключевыми словами
    const skillAdviceMap = {
      "коммуникативн": "Для развития коммуникативных навыков: 1) Участвуйте в дебатах и дискуссиях, 2) Практикуйте публичные выступления (Toastmasters, клубы), 3) Развивайте активное слушание, 4) Изучайте психологию общения, 5) Работайте в командах над проектами, 6) Читайте книги по риторике и переговорам.",
      "аналитическ": "Для развития аналитического мышления: 1) Решайте логические задачи ежедневно (LeetCode, Codewars), 2) Изучайте математику и статистику, 3) Анализируйте данные из реальных проектов, 4) Читайте научную литературу, 5) Практикуйтесь на Kaggle, 6) Изучайте методы анализа данных.",
      "творческ": "Для развития творческого мышления: 1) Экспериментируйте с разными техниками, 2) Изучайте искусство и дизайн, 3) Ведите творческий дневник или скетчбук, 4) Практикуйте мозговой штурм, 5) Изучайте работы мастеров, 6) Пробуйте новые инструменты.",
      "техническ": "Для развития технических навыков: 1) Изучайте программирование (freeCodeCamp, The Odin Project), 2) Работайте над реальными проектами, 3) Изучайте документацию, 4) Участвуйте в open-source, 5) Решайте задачи на LeetCode, 6) Создавайте портфолио.",
      "организационн": "Для развития организационных способностей: 1) Планируйте проекты (Trello, Notion), 2) Изучайте тайм-менеджмент, 3) Практикуйте делегирование, 4) Ставьте SMART-цели, 5) Анализируйте эффективность процессов, 6) Изучайте методологии управления проектами.",
      "команд": "Для развития навыков работы в команде: 1) Участвуйте в групповых проектах, 2) Изучайте командную динамику, 3) Практикуйте активное слушание, 4) Развивайте эмпатию, 5) Учитесь давать и принимать обратную связь, 6) Работайте над коммуникацией в команде.",
      "лидерск": "Для развития лидерских качеств: 1) Берите ответственность за проекты, 2) Изучайте теории лидерства, 3) Практикуйте делегирование, 4) Развивайте эмоциональный интеллект, 5) Учитесь принимать решения, 6) Найдите ментора-лидера.",
      "эмоциональн": "Для развития эмоционального интеллекта: 1) Изучайте свои эмоции, 2) Практикуйте эмпатию, 3) Развивайте самосознание, 4) Учитесь управлять стрессом, 5) Практикуйте активное слушание, 6) Читайте книги по эмоциональному интеллекту.",
      "тайм": "Для развития тайм-менеджмента: 1) Используйте техники Pomodoro, 2) Планируйте день заранее, 3) Расставляйте приоритеты (матрица Эйзенхауэра), 4) Избегайте многозадачности, 5) Делегируйте задачи, 6) Анализируйте, куда уходит время.",
      "критическ": "Для развития критического мышления: 1) Задавайте вопросы 'почему?', 2) Анализируйте источники информации, 3) Рассматривайте разные точки зрения, 4) Проверяйте факты, 5) Избегайте когнитивных искажений, 6) Практикуйте логическое мышление."
    };
    
    // Ищем совпадение по ключевым словам
    for (const [keyword, advice] of Object.entries(skillAdviceMap)) {
      if (lowerMessage.includes(keyword)) {
        return advice;
      }
    }
    
    // Если конкретный навык не найден, даем общий совет
    return "Для развития навыков рекомендую: 1) Регулярно практиковаться, 2) Искать обратную связь от экспертов, 3) Изучать лучшие практики в вашей области, 4) Применять знания на реальных проектах, 5) Учиться у опытных профессионалов. Укажите конкретный навык (например, 'аналитическое мышление' или 'коммуникативные навыки'), и я дам более детальные рекомендации!";
  }

  // Общие советы
  getLocalGeneralAdvice(messages) {
    return "Для успешного развития карьеры рекомендую: 1) Определить свои сильные стороны, 2) Постоянно учиться новому, 3) Строить профессиональную сеть, 4) Ставить конкретные цели, 5) Искать ментора или наставника.";
  }

  // Улучшенные рекомендации профессий с AI
  async getEnhancedProfessionRecommendation(skillScores, userAnswers, textAnswers = []) {
    // Определяем топ навыки для контекста
    const sortedSkills = Object.entries(skillScores).sort((a, b) => b[1] - a[1]);
    const topSkills = sortedSkills.slice(0, 3).map(([skill, score]) => `${skill} (${score}%)`).join(', ');
    
    const messages = [
      {
        role: 'system',
        content: 'Ты опытный карьерный консультант и профориентолог. Твоя задача - проанализировать данные пользователя и дать точную, обоснованную рекомендацию профессии. Отвечай на русском языке. Формат ответа: название профессии (на первой строке), затем обоснование (2-3 предложения с конкретными причинами).'
      },
      {
        role: 'user',
        content: `Проанализируй следующие данные и порекомендуй профессию:

ТОП-3 навыка пользователя:
${topSkills}

Все навыки:
${JSON.stringify(skillScores, null, 2)}

Ответы на вопросы теста:
${userAnswers.map((ans, idx) => `Вопрос ${idx + 1}: вариант ${ans}`).join('\n')}

Дополнительные текстовые ответы пользователя:
${textAnswers.length > 0 ? textAnswers.map((ans, idx) => `${idx + 1}. ${ans}`).join('\n') : 'Нет текстовых ответов'}

Проанализируй эти данные и порекомендуй ОДНУ наиболее подходящую профессию с детальным обоснованием.`
      }
    ];

    return await this.callAI(messages, { temperature: 0.8, max_tokens: 300 });
  }

  // Персонализированные советы по развитию навыков
  async getPersonalizedSkillAdvice(skillScores, weaknesses) {
    const weakSkillsList = weaknesses.map(w => `${w.skill} (текущий уровень: ${w.score}%)`).join('\n');
    const topSkills = Object.entries(skillScores)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([skill, score]) => `${skill} (${score}%)`)
      .join(', ');
    
    const messages = [
      {
        role: 'system',
        content: 'Ты опытный карьерный коуч и тренер по развитию навыков. Дай конкретные, практические, персонализированные советы. Для каждого навыка предложи 3-4 конкретных действия с примерами. Отвечай на русском языке, структурированно, используй нумерацию или маркеры.'
      },
      {
        role: 'user',
        content: `Пользователь имеет следующие характеристики:

СИЛЬНЫЕ СТОРОНЫ (топ-3):
${topSkills}

СЛАБЫЕ СТОРОНЫ (требуют развития):
${weakSkillsList}

Все навыки пользователя:
${JSON.stringify(skillScores, null, 2)}

Дай персональные рекомендации по развитию слабых навыков. Для каждого навыка:
1. Объясни, почему важно его развивать
2. Предложи 3-4 конкретных практических действия
3. Укажи ресурсы или способы практики

Будь конкретным и практичным. Избегай общих фраз.`
      }
    ];

    return await this.callAI(messages, { temperature: 0.85, max_tokens: 600 });
  }

  // Чат-бот для консультаций
  async chatWithBot(userMessage, conversationHistory = []) {
    const messages = [
      {
        role: 'system',
        content: `Ты опытный карьерный консультант SkillPath с глубокими знаниями в области профориентации, образования и карьерного развития.

Твоя задача:
- Давать конкретные, персонализированные ответы на основе вопроса пользователя
- Использовать примеры и практические советы
- Быть дружелюбным, поддерживающим и мотивирующим
- Отвечать на русском языке, развернуто (2-4 предложения минимум)
- Избегать общих фраз, быть конкретным

Если пользователь спрашивает о навыках - дай конкретные способы развития.
Если о профессии - опиши профессию детально с примерами.
Если о карьере - дай практические шаги.

ВАЖНО: Каждый ответ должен быть уникальным и релевантным конкретному вопросу пользователя.`
      },
      ...conversationHistory,
      {
        role: 'user',
        content: userMessage
      }
    ];

    return await this.callAI(messages, { temperature: 0.9, max_tokens: 500 });
  }

  // Анализ текстовых ответов
  async analyzeTextAnswers(textAnswers) {
    if (!textAnswers || textAnswers.length === 0) {
      return null;
    }

    const messages = [
      {
        role: 'system',
        content: `Ты опытный психолог-профориентолог с глубоким пониманием человеческой психологии и карьерного развития.

Твоя задача - провести глубокий анализ текстовых ответов пользователя и выявить:
- Скрытые интересы, мотивации и ценности
- Тип личности и особенности характера
- Профессиональные склонности
- Рекомендации по сферам деятельности

Отвечай на русском языке, структурированно, с конкретными примерами из ответов пользователя. Будь детальным и проницательным.`
      },
      {
        role: 'user',
        content: `Проведи глубокий психологический анализ следующих текстовых ответов пользователя:

ОТВЕТЫ ПОЛЬЗОВАТЕЛЯ:
${textAnswers.map((answer, index) => `
Вопрос ${index + 1}:
${answer}
`).join('\n---\n')}

Проанализируй каждый ответ и дай развернутый анализ:
1. ОСНОВНЫЕ ИНТЕРЕСЫ И СКЛОННОСТИ (что мотивирует, что нравится)
2. ТИП ЛИЧНОСТИ (краткая характеристика с обоснованием)
3. ПРОФЕССИОНАЛЬНЫЕ СКЛОННОСТИ (к каким типам деятельности тянется)
4. РЕКОМЕНДУЕМЫЕ СФЕРЫ ДЕЯТЕЛЬНОСТИ (3-4 конкретные сферы с обоснованием)

Используй конкретные примеры из ответов пользователя для обоснования своих выводов.`
      }
    ];

    return await this.callAI(messages, { temperature: 0.8, max_tokens: 700 });
  }

  // Установка API ключа (для будущего использования)
  setAPIKey(key) {
    this.apiKey = key;
  }

  // Переключение провайдера
  setProvider(provider) {
    this.provider = provider;
    // Можно добавить логику для разных провайдеров
  }
}

// Создаем глобальный экземпляр
const aiService = new AIService();
